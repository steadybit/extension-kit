name: CVE Scan Main

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name to use (defaults to github.repository if not provided)'
        required: false
        type: string
      image_tag:
        description: 'Image tag to scan'
        required: false
        type: string
      severities:
        description: 'Severities to include in the scan'
        required: false
        default: 'CRITICAL,HIGH'
        type: string
      add_to_github_security:
        description: 'Whether to add the scan results to the GitHub Security tab'
        required: false
        default: false
        type: boolean
      add_to_securityhub:
        description: 'Whether to send the scan results to AWS Security Hub'
        required: false
        default: false
        type: boolean
      trivy_version:
        description: 'Trivy version to use'
        required: false
        default: 'v0.68.1'
        type: string
      scan_type:
        description: 'Type of scan to perform (image, fs, etc.)'
        required: false
        default: 'image'
        type: string
      scan-ref:
        description: 'Scan reference'
        required: false
        default: '.'
        type: string
      checkout_ref:
        description: 'The git ref to checkout when scan_type is fs'
        required: false
        type: string

jobs:
  cve_scan:
    permissions:
      contents: read
      security-events: write
      packages: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.checkout_ref }}
          fetch-depth: 0

      - name: Log in to the container registry
        if: inputs.scan_type == 'image'
        uses: docker/login-action@v3 # NOSONAR githubactions:S7637 - verified action creator
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name
        id: image
        run: echo "name=${{ inputs.image_name || github.repository }}" >> $GITHUB_OUTPUT

      - name: Create ignore file for Trivy if not present
        run: |
          test -f .trivyignore.yml || touch .trivyignore.yml

      - name: Run Trivy
        uses: aquasecurity/trivy-action@0.33.1 # NOSONAR githubactions:S7637 - verified action creator
        env:
          TRIVY_DISABLE_VEX_NOTICE: 'true'
          TRIVY_SHOW_SUPPRESSED: 'true'
          TRIVY_IGNOREFILE: .trivyignore.yml # use env as `trivyignores` action parameter has bugs --> https://github.com/aquasecurity/trivy-action/issues/436
        with:
          scan-type: ${{ inputs.scan_type }}
          image-ref: ${{ inputs.scan_type == 'image' && format('ghcr.io/{0}:{1}', steps.image.outputs.name, inputs.image_tag) || '' }}
          scan-ref: ${{ inputs.scan_type == 'fs' && inputs.scan-ref || '' }}
          format: 'json'
          ignore-unfixed: true
          severity: ${{ inputs.severities }}
          output: 'trivy-results.json'
          version: ${{ inputs.trivy_version }}

      - name: Set artifact name
        id: artifact
        env:
          INPUT_SCAN_TYPE: ${{ inputs.scan_type }}
          INPUT_SCAN_REF: ${{ inputs.scan-ref }}
        run: |
          if [ "$INPUT_SCAN_TYPE" = "image" ]; then
            ARTIFACT_NAME="trivy-results-${{ steps.image.outputs.name }}"
            ARTIFACT_NAME="${ARTIFACT_NAME//\//-}"
          else
            ARTIFACT_NAME="trivy-results-$INPUT_SCAN_REF"
            ARTIFACT_NAME="${ARTIFACT_NAME//\//-}"
            ARTIFACT_NAME="${ARTIFACT_NAME//.}"
          fi
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload Trivy results as artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: trivy-results.json

      #TODO Replace with templates? https://github.com/aquasecurity/trivy/pull/3202/files

      - name: Add Trivy results to Step Summary
        run: |
          cat trivy-results.json | jq -r '
            if ([.Results[]?.Vulnerabilities[]?] | length) > 0 then
              "## üîç Trivy Security Scan Results\n" +
              "| Vulnerability | Severity | Target | Package | Installed Version | Fixed Version |\n" +
              "| --- | --- | --- | --- | --- | --- |\n" +
              (
                [
                  .Results[] | (.Target as $target | (.Vulnerabilities[]? // empty) |
                    "| `\(.VulnerabilityID // "N/A")` | **\(.Severity // "N/A")** | \($target // "N/A") | <span>\("`" + (.PkgName // "N/A") + "`" + (if ((.PkgPath // "") != "") then "<br>`" + (.PkgPath) + "`" else "" end))</span> | `\(.InstalledVersion // "N/A")` | `\(.FixedVersion // "N/A")` |"
                  )
                ] | join("\n")
              )
            else 
              "## üîç Trivy Security Scan Results\n‚úÖ No vulnerabilities found!"
            end
          ' >> $GITHUB_STEP_SUMMARY

      - name: Add ignored Trivy results to Step Summary
        run: |
          cat trivy-results.json | jq -r '
            if ([.Results[]?.ExperimentalModifiedFindings[]?] | length) > 0 then
              "## üôà Ignored Trivy Security Scan Results\n" +
              "| Statement | Source | Vulnerability | Severity | Target | Package | Installed Version | Fixed Version |\n" +
              "| --- | --- | --- | --- | --- | --- | --- | --- |\n" +
              (
                [
                  .Results[] | (.Target as $target | (.ExperimentalModifiedFindings[]? // empty) |
                    "| \(.Statement // "N/A") | `\(.Source // "N/A")` | `\(.Finding.VulnerabilityID // "N/A")` | **\(.Finding.Severity // "N/A")** | \($target // "N/A") | <span>\("`" + (.Finding.PkgName // "N/A") + "`" + (if ((.Finding.PkgPath // "") != "") then "<br>`" + (.Finding.PkgPath) + "`" else "" end))</span> | `\(.Finding.InstalledVersion // "N/A")` | `\(.Finding.FixedVersion // "N/A")` |"
                  )
                ] | join("\n")
              )
            else
              ""
            end
          ' >> $GITHUB_STEP_SUMMARY

      - name: Add hint for local verification (image)
        if: inputs.scan_type == 'image'
        env:
          INPUT_IMAGE_TAG: ${{ inputs.image_tag }}
          INPUT_SEVERITIES: ${{ inputs.severities }}
        run: |
          echo "## üõ†Ô∏è To verify the scan results locally, run the following command from the extensions directory:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ steps.image.outputs.name }}:$INPUT_IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "trivy image --severity $INPUT_SEVERITIES --ignore-unfixed --ignorefile .trivyignore.yml --format table --show-suppressed ghcr.io/${{ steps.image.outputs.name }}:$INPUT_IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Add hint for local verification (fs)
        if: inputs.scan_type == 'fs'
        env:
          INPUT_SEVERITIES: ${{ inputs.severities }}
        run: |
          echo "## üõ†Ô∏è To verify the scan results locally, run the following command from the extensions directory:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "trivy fs --severity $INPUT_SEVERITIES --ignore-unfixed --ignorefile .trivyignore.yml --format table --show-suppressed ." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Convert Trivy JSON to SARIF
        run: |
          trivy convert --format sarif --output trivy-results.sarif trivy-results.json

      - name: Configure AWS credentials (Security Hub)
        if: inputs.add_to_securityhub
        uses: aws-actions/configure-aws-credentials@v5 # NOSONAR githubactions:S7637 - verified action creator
        with:
          role-to-assume: "arn:aws:iam::244471902119:role/allow-auto-deploy-from-other-accounts"
          aws-region: eu-central-1

      - name: Generate ASFF report for AWS Security Hub
        if: inputs.add_to_securityhub
        env:
          AWS_REGION: eu-central-1
        run: |
          set -euo pipefail
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          export AWS_ACCOUNT_ID
          
          # Download ASFF template explicitly (trivy-action does not ship contrib templates)
          curl -fsSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/asff.tpl -o asff.tpl
          
          trivy convert --format template --template "@asff.tpl" \
            --output trivy-results.asff trivy-results.json

      - name: Import findings into AWS Security Hub
        if: inputs.add_to_securityhub
        run: |
          set -euo pipefail

          # Trivy's ASFF template output can be either a top-level array or an object with a "Findings" array.
          if jq -e 'has("Findings")' trivy-results.asff >/dev/null 2>&1; then
            jq '.Findings' trivy-results.asff > trivy-findings.json
          else
            cp trivy-results.asff trivy-findings.json
          fi

          TOTAL=$(jq 'length' trivy-findings.json)
          if [ "$TOTAL" -eq 0 ]; then
            echo "No findings to import into Security Hub"
            exit 0
          fi

          # Security Hub BatchImportFindings accepts max 100 findings per request.
          for ((i=0; i<TOTAL; i+=100)); do
            jq ".[$i:($i+100)]" trivy-findings.json > trivy-findings-batch.json
            aws securityhub batch-import-findings --findings file://trivy-findings-batch.json >/dev/null
          done

          echo "Imported $TOTAL findings into AWS Security Hub"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: inputs.add_to_github_security
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Fail if vulnerabilities found
        run: |
          VULN_COUNT=$(cat trivy-results.sarif | jq '.runs[0].results | length')
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "Found $VULN_COUNT vulnerabilities"
            exit 1
          fi
