name: CVE Scan Main

on:
  workflow_call:
    inputs:
      image_tag:
        description: 'Image tag to scan'
        required: true
        type: string
      severities:
        description: 'Severities to include in the scan'
        required: false
        default: 'CRITICAL,HIGH'
        type: string
      add_to_github_security:
        description: 'Whether to add the scan results to the GitHub Security tab'
        required: false
        default: false
        type: boolean
      trivy_version:
        description: 'Trivy version to use'
        required: false
        default: 'v0.67.2'
        type: string

jobs:
  cve_scan:
    permissions:
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - name: Write .trivyignore.global
        run: |
          cat <<EOF > .trivyignore.yml
          vulnerabilities:
            - id: CVE-0000-0000
              statement: Just an example
              expired_at: 2020-01-01
          EOF

      - name: Run Trivy
        uses: aquasecurity/trivy-action@0.33.1
        env:
          TRIVY_DISABLE_VEX_NOTICE: 'true'
          TRIVY_SHOW_SUPPRESSED: 'true'
        with:
          image-ref: 'ghcr.io/${{ github.repository }}:${{ inputs.image_tag }}'
          format: 'json'
          ignore-unfixed: true
          severity: ${{ inputs.severities }}
          output: 'trivy-results.json'
          version: ${{ inputs.trivy_version }}
          trivyignores: '.trivyignore.yml, .trivyignore.global.yml'



      - name: Add Trivy results to Step Summary
        run: |
          cat trivy-results.json | jq -r '
            if ([.Results[]?.Vulnerabilities[]?] | length) > 0 then
              "## ðŸ” Trivy Security Scan Results\n" +
              "| Vulnerability | Severity | Package | Title | Installed Version | Fixed Version |\n" +
              "| --- | --- | --- | --- | --- | --- |\n" +
              (
                [
                  (.Results[]?.Vulnerabilities[]? // empty) |
                  "| `\(.VulnerabilityID // "N/A")` | **\(.Severity // "N/A")** | `\(.PkgPath // "N/A")` | \((.Title // "N/A") | gsub("[`\n]"; " ") | .[0:80]) | `\(.InstalledVersion // "N/A")` | `\(.FixedVersion // "N/A")` |"
                ] | join("\n")
              )
            else 
              "## ðŸ” Trivy Security Scan Results\nâœ… No vulnerabilities found!"
            end
          ' >> $GITHUB_STEP_SUMMARY

      - name: Add ignored Trivy results to Step Summary
        run: |       
          cat trivy-results.json | jq -r '
            if ([.Results[]?.ExperimentalModifiedFindings[]?] | length) > 0 then
              "## ðŸ” Trivy Security Scan Results\n" +
              "| Statement | Source | Vulnerability | Severity | Package | Title | Installed Version | Fixed Version |\n" +
              "| --- | --- | --- | --- | --- | --- | --- | --- |\n" +
              (
                [
                  (.Results[]?.ExperimentalModifiedFindings[]? // empty) |
                  "| \(.Statement // "N/A") | `\(.Source // "N/A")` | `\(.Finding.VulnerabilityID // "N/A")` | **\(.Finding.Severity // "N/A")** | `\(.Finding.PkgPath // "N/A")` | \((.Finding.Title // "N/A") | gsub("[`\n]"; " ") | .[0:80]) | `\(.Finding.InstalledVersion // "N/A")` | `\(.Finding.FixedVersion // "N/A")` |"
                ] | join("\n")
              )
            end
          ' >> $GITHUB_STEP_SUMMARY

      - name: Convert Trivy JSON to SARIF
        if: inputs.add_to_github_security
        run: |
          trivy convert --format sarif --output trivy-results.sarif trivy-results.json

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: inputs.add_to_github_security
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Fail if vulnerabilities found
        run: |
          VULN_COUNT=$(cat trivy-results.sarif | jq '.runs[0].results | length')
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "Found $VULN_COUNT vulnerabilities"
            exit 1
          fi
