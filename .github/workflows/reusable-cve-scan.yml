name: CVE Scan Main

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Image name to use (defaults to github.repository if not provided)'
        required: false
        type: string
      image_tag:
        description: 'Image tag to scan'
        required: false
        type: string
      severities:
        description: 'Severities to include in the scan'
        required: false
        default: 'CRITICAL,HIGH'
        type: string
      add_to_github_security:
        description: 'Whether to add the scan results to the GitHub Security tab'
        required: false
        default: false
        type: boolean
      trivy_version:
        description: 'Trivy version to use'
        required: false
        default: 'v0.68.1'
        type: string
      scan_type:
        description: 'Type of scan to perform (image, fs, etc.)'
        required: false
        default: 'image'
        type: string

jobs:
  cve_scan:
    permissions:
      contents: read
      security-events: write
      packages: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Log in to the container registry
        if: inputs.scan_type == 'image'
        uses: docker/login-action@v3 # NOSONAR githubactions:S7637 - verified action creator
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name
        id: image
        run: echo "name=${{ inputs.image_name || github.repository }}" >> $GITHUB_OUTPUT

      - name: Create ignore file for Trivy if not present
        run: |
          test -f .trivyignore.yml || touch .trivyignore.yml

      - name: Run Trivy
        uses: aquasecurity/trivy-action@0.33.1 # NOSONAR githubactions:S7637 - verified action creator
        env:
          TRIVY_DISABLE_VEX_NOTICE: 'true'
          TRIVY_SHOW_SUPPRESSED: 'true'
          TRIVY_IGNOREFILE: .trivyignore.yml # use env as `trivyignores` action parameter has bugs --> https://github.com/aquasecurity/trivy-action/issues/436
        with:
          scan-type: ${{ inputs.scan_type }}
          image-ref: ${{ inputs.scan_type == 'image' && format('ghcr.io/{0}:{1}', steps.image.outputs.name, inputs.image_tag) || '' }}
          format: 'json'
          ignore-unfixed: true
          severity: ${{ inputs.severities }}
          output: 'trivy-results.json'
          version: ${{ inputs.trivy_version }}

      - name: Set artifact name
        id: artifact
        run: |
          if [ "${{ inputs.scan_type }}" = "image" ]; then
            ARTIFACT_NAME="trivy-results-${{ steps.image.outputs.name }}"
            ARTIFACT_NAME="${ARTIFACT_NAME//\//-}"
          else
            ARTIFACT_NAME="trivy-results-fs"
          fi
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload Trivy results as artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: trivy-results.json

      #TODO Replace with templates? https://github.com/aquasecurity/trivy/pull/3202/files

      - name: Add Trivy results to Step Summary
        run: |
          cat trivy-results.json | jq -r '
            if ([.Results[]?.Vulnerabilities[]?] | length) > 0 then
              "## üîç Trivy Security Scan Results\n" +
              "| Vulnerability | Severity | Target | Package | Installed Version | Fixed Version |\n" +
              "| --- | --- | --- | --- | --- | --- |\n" +
              (
                [
                  .Results[] | (.Target as $target | (.Vulnerabilities[]? // empty) |
                    "| `\(.VulnerabilityID // "N/A")` | **\(.Severity // "N/A")** | \($target // "N/A") | <span>\("`" + (.PkgName // "N/A") + "`" + (if ((.PkgPath // "") != "") then "<br>`" + (.PkgPath) + "`" else "" end))</span> | `\(.InstalledVersion // "N/A")` | `\(.FixedVersion // "N/A")` |"
                  )
                ] | join("\n")
              )
            else 
              "## üîç Trivy Security Scan Results\n‚úÖ No vulnerabilities found!"
            end
          ' >> $GITHUB_STEP_SUMMARY

      - name: Add ignored Trivy results to Step Summary
        run: |
          cat trivy-results.json | jq -r '
            if ([.Results[]?.ExperimentalModifiedFindings[]?] | length) > 0 then
              "## üôà Ignored Trivy Security Scan Results\n" +
              "| Statement | Source | Vulnerability | Severity | Target | Package | Installed Version | Fixed Version |\n" +
              "| --- | --- | --- | --- | --- | --- | --- | --- |\n" +
              (
                [
                  .Results[] | (.Target as $target | (.ExperimentalModifiedFindings[]? // empty) |
                    "| \(.Statement // "N/A") | `\(.Source // "N/A")` | `\(.Finding.VulnerabilityID // "N/A")` | **\(.Finding.Severity // "N/A")** | \($target // "N/A") | <span>\("`" + (.Finding.PkgName // "N/A") + "`" + (if ((.Finding.PkgPath // "") != "") then "<br>`" + (.Finding.PkgPath) + "`" else "" end))</span> | `\(.Finding.InstalledVersion // "N/A")` | `\(.Finding.FixedVersion // "N/A")` |"
                  )
                ] | join("\n")
              )
            else
              ""
            end
          ' >> $GITHUB_STEP_SUMMARY

      - name: Add hint for local verification (image)
        if: inputs.scan_type == 'image'
        env:
          INPUT_IMAGE_TAG: ${{ inputs.image_tag }}
          INPUT_SEVERITIES: ${{ inputs.severities }}
        run: |
          echo "## üõ†Ô∏è To verify the scan results locally, run the following command from the extensions directory:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ steps.image.outputs.name }}:$INPUT_IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "trivy image --severity $INPUT_SEVERITIES --ignore-unfixed --ignorefile .trivyignore.yml --format table --show-suppressed ghcr.io/${{ steps.image.outputs.name }}:$INPUT_IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Add hint for local verification (fs)
        if: inputs.scan_type == 'fs'
        env:
          INPUT_SEVERITIES: ${{ inputs.severities }}
        run: |
          echo "## üõ†Ô∏è To verify the scan results locally, run the following command from the extensions directory:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "trivy fs --severity $INPUT_SEVERITIES --ignore-unfixed --ignorefile .trivyignore.yml --format table --show-suppressed ." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Convert Trivy JSON to SARIF
        run: |
          trivy convert --format sarif --output trivy-results.sarif trivy-results.json

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: inputs.add_to_github_security
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Fail if vulnerabilities found
        run: |
          VULN_COUNT=$(cat trivy-results.sarif | jq '.runs[0].results | length')
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "Found $VULN_COUNT vulnerabilities"
            exit 1
          fi
