name: CVE Scan Main

on:
  workflow_call:
    inputs:
      image_tag:
        description: 'Image tag to scan'
        required: true
        type: string
      severities:
        description: 'Severities to include in the scan'
        required: false
        default: 'CRITICAL,HIGH'
        type: string
      add_to_github_security:
        description: 'Whether to add the scan results to the GitHub Security tab'
        required: false
        default: false
        type: boolean
      trivy_version:
        description: 'Trivy version to use'
        required: false
        default: 'v0.67.2'
        type: string

jobs:
  cve_scan:
    permissions:
      security-events: write
    runs-on: ubuntu-latest
    steps:
      - name: Run Trivy
        uses: aquasecurity/trivy-action@0.33.1
        env:
          TRIVY_DISABLE_VEX_NOTICE: 'true'
        with:
          image-ref: 'ghcr.io/${{ github.repository }}:${{ inputs.image_tag }}'
          format: 'sarif'
          ignore-unfixed: true
          severity: ${{ inputs.severities }}
          output: 'trivy-results.sarif'
          version: ${{ inputs.trivy_version }}
          limit-severities-for-sarif: true

      - name: Add Trivy results to Step Summary
        run: |
          cat trivy-results.sarif | jq -r '
            if (.runs[0].results | length) > 0 then
            "## üîç Trivy Security Scan Results\n" +
            "| Vulnerability | Description | Location |\n" +
            "| --- | --- | --- |\n" +
            (
            [
            .runs[0].results[] |
            "| `\(.ruleId)` | <pre>\(.message.text | gsub("[`\n]"; "<br>"))</pre> | `\(.locations[0].physicalLocation.artifactLocation.uri // "N/A")` |"
            ] | join("\n")
            )
            else
            "## üîç Trivy Security Scan Results\n‚úÖ No vulnerabilities found!"
            end
          ' >> $GITHUB_STEP_SUMMARY

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: inputs.add_to_github_security
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Fail if vulnerabilities found
        run: |
          VULN_COUNT=$(cat trivy-results.sarif | jq '.runs[0].results | length')
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "Found $VULN_COUNT vulnerabilities"
            exit 1
          fi
